<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7th Grade English Review (MCQ & Refined Essays)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light gray-blue background */
        }
        .quiz-card {
            background-color: #ffffff;
            border-radius: 1rem; /* Softer, larger radius */
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .option-button, .essay-textarea {
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            border-width: 2px;
            border-radius: 0.5rem; /* Tailwind rounded-lg */
        }
        .essay-textarea {
            width: 100%;
            min-height: 150px; /* Standard height for essay input */
            padding: 0.75rem; /* p-3 */
            border-color: #cbd5e1; /* slate-300 */
            line-height: 1.5; /* Improved readability for typed text */
        }
        .essay-textarea:focus {
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 2px #bfdbfe; /* blue-200 ring */
            outline: none;
        }
        .option-button:hover {
            border-color: #60a5fa; /* Tailwind blue-400 for hover */
            background-color: #f0f9ff; /* Tailwind blue-50 for hover */
        }
        .option-button.selected {
            border-color: #3b82f6; /* Tailwind blue-500 for selected */
            background-color: #dbeafe; /* Tailwind blue-100 for selected */
            box-shadow: 0 0 0 2px #bfdbfe; /* Tailwind blue-200 ring for selected */
        }
        .option-button.correct {
            background-color: #dcfce7 !important; /* Tailwind green-100 */
            border-color: #22c55e !important; /* Tailwind green-500 */
            color: #166534; /* Darker green text for contrast */
        }
        .option-button.incorrect {
            background-color: #fee2e2 !important; /* Tailwind red-100 */
            border-color: #ef4444 !important; /* Tailwind red-500 */
            color: #991b1b; /* Darker red text for contrast */
        }
        .primary-button {
            background-image: linear-gradient(to right, #3b82f6, #2563eb); /* Blue gradient */
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .primary-button:hover {
            background-image: linear-gradient(to right, #2563eb, #1d4ed8);
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
        }
        .primary-button:disabled {
            background-image: none;
            background-color: #9ca3af; /* Tailwind gray-400 */
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .secondary-button { /* For Next Question button */
            background-image: linear-gradient(to right, #10b981, #059669); /* Green gradient */
        }
        .secondary-button:hover {
            background-image: linear-gradient(to right, #059669, #047857);
        }
        .restart-button { /* For Restart Quiz button */
             background-image: linear-gradient(to right, #6366f1, #4f46e5); /* Indigo/Purple gradient */
        }
       .restart-button:hover {
            background-image: linear-gradient(to right, #4f46e5, #4338ca);
        }
        .passage-content::-webkit-scrollbar { width: 6px; }
        .passage-content::-webkit-scrollbar-track { background: #e5e7eb; border-radius: 10px; }
        .passage-content::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; }
        .passage-content::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        .mcq-explanation-text {
            font-size: 0.875rem; /* text-sm */
            color: #374151; /* gray-700 */
            margin-top: 0.75rem; /* mt-3 */
            padding: 0.75rem; /* p-3 */
            background-color: #f3f4f6; /* gray-100 */
            border-left: 4px solid #60a5fa; /* blue-400 */
            border-radius: 0.375rem; /* rounded-md */
            line-height: 1.6;
            display: block;
        }
        .essay-feedback-container {
            margin-top: 0.5rem; /* Add some space above the model answer/checklist block */
        }
        .essay-feedback-container h4 {
            font-size: 1rem; /* text-base, slightly larger for section titles */
            font-weight: 600; /* semibold */
            color: #1f2937; /* gray-800 */
            margin-bottom: 0.5rem; /* mb-2 */
            margin-top: 0.75rem; /* mt-3, especially for the second h4 */
        }
        .essay-feedback-container p, .essay-feedback-container ul {
            font-size: 0.875rem; /* text-sm */
            color: #374151; /* gray-700 */
            background-color: #f9fafb; /* gray-50 */
            padding: 0.75rem; /* p-3 */
            border: 1px solid #e5e7eb; /* gray-200 border for definition */
            border-radius: 0.375rem; /* rounded-md */
            line-height: 1.6;
        }
        .essay-feedback-container ul {
            list-style-position: inside;
            list-style-type: disc;
            padding-left: 1.25rem; /* Add padding for bullet points */
        }
        .essay-feedback-container > div + div { /* Margin between model answer and checklist sections */
            margin-top: 1rem; /* mt-4 */
        }

        .progress-bar-container { height: 10px; background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; margin-bottom: 1.5rem; }
        .progress-bar { height: 100%; background-color: #3b82f6; transition: width 0.3s ease-in-out; border-radius: 9999px; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 sm:p-6">

    <div id="quiz-container" class="quiz-card p-5 sm:p-8 w-full max-w-2xl">
        <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-center text-slate-800 mb-2">7th Grade English Review</h1>
        <p class="text-center text-sm text-slate-500 mb-6">Test your knowledge & practice writing!</p>

        <div class="progress-bar-container">
            <div id="progress-bar" class="progress-bar" style="width: 0%;"></div>
        </div>

        <div id="passage-area" class="mb-5 p-3 sm:p-4 bg-slate-50 border border-slate-200 rounded-lg max-h-40 sm:max-h-48 overflow-y-auto passage-content" style="display: none;">
            <h3 class="text-xs sm:text-sm font-semibold text-slate-600 mb-1 sm:mb-2">Reading Passage:</h3>
            <p id="passage-text" class="text-xs sm:text-sm text-slate-700 whitespace-pre-line leading-relaxed"></p>
        </div>

        <div id="question-area">
            <p id="progress-text" class="text-xs sm:text-sm text-slate-500 mb-2 text-right"></p>
            <h2 id="question-text" class="text-md sm:text-lg font-semibold text-slate-800 mb-4 min-h-[3em] sm:min-h-[2.5em] leading-snug"></h2>
            <div id="options-container" class="space-y-3 sm:space-y-4 mt-2">
                </div>
        </div>

        <div id="feedback-area" class="mt-5 text-sm py-1">
            <p id="feedback-text" class="font-medium"></p>
            </div>

        <div id="navigation-area" class="mt-6 sm:mt-8 flex flex-col sm:flex-row justify-between items-center gap-3 sm:gap-0">
            <button id="submit-button" class="primary-button w-full sm:w-auto text-white font-semibold py-2.5 px-6 rounded-lg shadow-md disabled:opacity-70 disabled:cursor-not-allowed">Submit Answer</button>
            <button id="next-button" class="secondary-button primary-button w-full sm:w-auto text-white font-semibold py-2.5 px-6 rounded-lg shadow-md" style="display: none;">Next Question</button>
        </div>

        <div id="score-area" class="text-center mt-8 py-6" style="display: none;">
            <h2 class="text-2xl sm:text-3xl font-bold text-slate-800">Quiz Completed!</h2>
            <p id="mcr-score-text" class="text-lg sm:text-xl text-slate-700 mt-3"></p>
            <p id="mcr-percentage-text" class="text-md sm:text-lg text-blue-600 font-semibold mt-1"></p>
            <p class="text-md text-slate-600 mt-4 px-2">You have also completed the essay practice sections. Review your writing based on the provided models and checklists!</p>
            <button id="restart-button" class="restart-button primary-button mt-8 text-white font-semibold py-3 px-10 rounded-lg shadow-md">Restart Quiz</button>
        </div>
    </div>

    <script>
        const Aethelgard_Passage = `The Lost City of Aethelgard

Deep within the Whispering Woods, legend spoke of Aethelgard, a city _____ (4) vanished centuries ago. Archaeologists believed its inhabitants _____ (5) master builders, erecting structures that defied the engineering of their time. They were also renowned for their astronomical knowledge, supposedly able _____ (6) predict celestial events with uncanny accuracy. The city's sudden disappearance remains a puzzle, with theories ranging from natural disasters to internal conflict.`;

        const UrbanGardening_Passage = `The Rise of Urban Gardening

In recent years, urban gardening has seen a significant surge in popularity. City dwellers are increasingly interested in (11)_____ their own food, transforming balconies and rooftops into green spaces. This trend not only provides fresh produce but also helps (12)_____ a connection with nature amidst concrete jungles. Many communities are now organizing workshops (13)_____ residents with the necessary skills.`;

        const questions = [
            // --- 30 MCQ Questions (Same as previous version) ---
            {
                question: "My brother _____ play the guitar every day when he was younger, but now he prefers the piano.",
                options: ["uses to", "used to", "is using", "use to"],
                answer: 1, passage: null, explanation: "'Used to' is the correct phrase to talk about past habits or states that are no longer true."
            },
            {
                question: "She is very keen _____ participating in the upcoming science fair.",
                options: ["to", "on", "for", "at"],
                answer: 1, passage: null, explanation: "The phrase 'keen on' is followed by a gerund (verb + -ing) to express enthusiasm for something."
            },
            {
                question: "The smartphone _____ I recently purchased has an excellent battery life.",
                options: ["who", "that", "where", "when"],
                answer: 1, passage: null, explanation: "'That' (or 'which') is a relative pronoun used to introduce a clause giving more information about a thing (the smartphone)."
            },
            { 
                question: "Deep within the Whispering Woods, legend spoke of Aethelgard, a city _____ (4) vanished centuries ago.",
                options: ["who", "which", "where", "whose"],
                answer: 1, passage: Aethelgard_Passage, explanation: "'Which' is used as a relative pronoun to refer to things (the city)."
            },
            { 
                question: "Archaeologists believed its inhabitants _____ (5) master builders, erecting structures that defied the engineering of their time.",
                options: ["are", "were", "will be", "be"],
                answer: 1, passage: Aethelgard_Passage, explanation: "'Were' (past simple of 'to be') is used because the passage refers to a past belief about inhabitants of an ancient city."
            },
            { 
                question: "They were also renowned for their astronomical knowledge, supposedly able _____ (6) predict celestial events with uncanny accuracy.",
                options: ["predict", "predicting", "to predict", "predicted"],
                answer: 2, passage: Aethelgard_Passage, explanation: "After 'able', we use the infinitive form 'to predict'."
            },
            {
                question: "The flight was delayed due to bad weather, _____ caused a lot of inconvenience for passengers.",
                options: ["who", "that", "which", "what"],
                answer: 2, passage: null, explanation: "'Which' is used to introduce a non-defining relative clause referring to the whole previous clause (the flight being delayed)."
            },
            {
                question: "The chef prepared the delicate dessert _____ to ensure it looked perfect.",
                options: ["careful", "care", "carefully", "more careful"],
                answer: 2, passage: null, explanation: "'Carefully' is an adverb of manner that describes how the chef prepared the dessert."
            },
            {
                question: "_____ you ever visited the new museum in the city center?",
                options: ["Do", "Are", "Have", "Did"],
                answer: 2, passage: null, explanation: "'Have' is used to form the present perfect tense ('Have you ever visited...'), which asks about experiences up to now."
            },
            {
                question: "Our grandparents _____ tell us fascinating stories every evening, but now they live too far away.",
                options: ["used to", "are used to", "use to", "were using to"],
                answer: 0, passage: null, explanation: "'Used to' indicates a past habit that is no longer true."
            },
            { 
                question: "City dwellers are increasingly interested in (11)_____ their own food, transforming balconies and rooftops into green spaces.",
                options: ["grow", "to grow", "growing", "grown"],
                answer: 2, passage: UrbanGardening_Passage, explanation: "After the preposition 'in' (in 'interested in'), we use a gerund ('growing')."
            },
            { 
                question: "This trend not only provides fresh produce but also helps (12)_____ a connection with nature amidst concrete jungles.",
                options: ["foster", "fostering", "to fostering", "fostered"],
                answer: 0, passage: UrbanGardening_Passage, explanation: "The verb 'help' can be followed by an infinitive with 'to' (to foster) or without 'to' (foster)."
            },
            { 
                question: "Many communities are now organizing workshops (13)_____ residents with the necessary skills.",
                options: ["equip", "to equip", "equipping", "equipped"],
                answer: 1, passage: UrbanGardening_Passage, explanation: "The infinitive 'to equip' is used here to express the purpose of the workshops."
            },
            {
                question: "While the children _____ in the park, it suddenly _____ to rain heavily.",
                options: ["played / was starting", "were playing / started", "had played / started", "play / start"],
                answer: 1, passage: null, explanation: "'Were playing' (past continuous) describes an ongoing action in the past that was interrupted by another action 'started' (past simple)."
            },
            {
                question: "Which sentence uses a countable noun correctly?",
                options: ["She showed great courages during the difficult time.", "He offered me some good advices.", "There are several new students in our class this year.", "We need to buy new furnitures for the living room."],
                answer: 2, passage: null, explanation: "'Students' is a countable noun, and 'several' is an appropriate quantifier. 'Courage', 'advice', and 'furniture' are uncountable."
            },
            {
                question: "Which of these nouns is generally uncountable?",
                options: ["Bottle", "Happiness", "Journey", "Report"],
                answer: 1, passage: null, explanation: "'Happiness' is an abstract noun and is generally uncountable. 'Bottle', 'journey', and 'report' are countable."
            },
            {
                question: "Which sentence uses a quantifier correctly?",
                options: ["There isn't many traffics on the road today.", "Can I have a few water, please?", "She has made a lot of progress in her studies.", "He ate too much cookies after dinner."],
                answer: 2, passage: null, explanation: "'Progress' is uncountable, so 'a lot of' is correct. 'Traffic' is uncountable (use 'much'). 'Water' is uncountable (use 'a little'). 'Cookies' are countable (use 'many')."
            },
            {
                question: "She _____ like spicy food when she was a child, but now she loves it.",
                options: ["didn't used to", "didn't use to", "not used to", "wasn't use to"],
                answer: 1, passage: null, explanation: "For the negative form of 'used to', we use 'didn't use to' (without the 'd' in 'use')."
            },
            {
                question: "_____ you _____ live in this neighborhood before moving here?",
                options: ["Did / used to", "Did / use to", "Were / used to", "Do / use to"],
                answer: 1, passage: null, explanation: "For questions with 'used to', we use 'Did [subject] use to...?' (without the 'd' in 'use')."
            },
            {
                question: "They decided _____ a new car after their old one broke down.",
                options: ["buying", "to buy", "buy", "for buying"],
                answer: 1, passage: null, explanation: "The verb 'decide' is followed by an infinitive (to + verb)."
            },
            {
                question: "My father enjoys _____ detective novels in his free time.",
                options: ["to read", "read", "reading", "for read"],
                answer: 2, passage: null, explanation: "The verb 'enjoy' is followed by a gerund (verb + -ing)."
            },
            {
                question: "He is very good _____ solving complex mathematical problems.",
                options: ["at", "to", "for", "on"],
                answer: 0, passage: null, explanation: "The phrase 'good at' is followed by a gerund (verb + -ing). 'Solving' is the gerund here."
            },
            {
                question: "That's the artist _____ paintings are displayed in the gallery.",
                options: ["who", "which", "whom", "whose"],
                answer: 3, passage: null, explanation: "'Whose' is a relative pronoun used to show possession (the artist's paintings)."
            },
            {
                question: "This is the park _____ we often have picnics on sunny days.",
                options: ["which", "that", "where", "who"],
                answer: 2, passage: null, explanation: "'Where' is a relative pronoun used to refer to a place (the park)."
            },
            {
                question: "By the time the guests arrived, she _____ all the preparations for the party.",
                options: ["finished", "was finishing", "had finished", "finishes"],
                answer: 2, passage: null, explanation: "The past perfect tense ('had finished') is used to describe an action completed before another action in the past (guests arrived)."
            },
            {
                question: "I _____ to Paris last year, but I _____ to Rome yet.",
                options: ["went / haven't been", "have gone / didn't go", "went / wasn't", "was going / haven't been"],
                answer: 0, passage: null, explanation: "'Went' (past simple) is used for a completed action at a specific time in the past ('last year'). 'Haven't been' (present perfect) is used for an action that hasn't happened up to now ('yet')."
            },
            {
                question: "Look at those dark clouds! I think it _____ soon.",
                options: ["is raining", "will rain", "rains", "rained"],
                answer: 1, passage: null, explanation: "'Will rain' (future simple) is used to make a prediction based on present evidence (dark clouds)."
            },
            {
                question: "The students listened _____ to the teacher's instructions.",
                options: ["attentive", "attention", "attentively", "more attentive"],
                answer: 2, passage: null, explanation: "'Attentively' is an adverb of manner that describes how the students listened."
            },
            {
                question: "She needs _____ sugar for her tea, but only _____ biscuits.",
                options: ["a little / a few", "a few / a little", "many / much", "much / many"],
                answer: 0, passage: null, explanation: "'A little' is used with uncountable nouns (like sugar), and 'a few' is used with countable nouns (like biscuits)."
            },
            { 
                question: "Could I have _____ water and _____ apples, please?",
                options: ["any / any", "some / some", "much / many", "a little / a few"],
                answer: 1, passage: null, explanation: "'Some' can be used with both uncountable nouns (like water) and plural countable nouns (like apples) in requests and affirmative sentences."
            },
            
            // --- 5 REFINED Essay Questions ---
            {
                type: 'essay',
                prompt: "Describe your favorite book, movie, or game. What is it about? Why do you like it so much? Mention at least two specific reasons. (Write at least 5 sentences)",
                modelAnswer: "My favorite movie is 'Spider-Man: Into the Spider-Verse'. It's an animated superhero film about Miles Morales becoming Spider-Man. I love it so much because the animation style is incredibly unique and visually stunning. Another reason is the great story about finding your own path and the importance of friendship and family. The music is also fantastic and fits the movie perfectly.",
                checklist: [
                    "Did I clearly name my favorite book, movie, or game?",
                    "Did I briefly explain what it is about?",
                    "Did I give at least two specific reasons why I like it?",
                    "Are my reasons clearly explained?",
                    "Is my answer at least 5 sentences long?",
                    "Did I check for spelling and grammar mistakes?"
                ],
                passage: null
            },
            {
                type: 'essay',
                prompt: "Write about a memorable event or celebration you attended (e.g., a birthday party, a school festival, a family gathering). What happened during the event? What made it memorable for you? (Write at least 5 sentences)",
                modelAnswer: "A memorable event I attended was my cousin's birthday party last year. It was held at a park, and there were many fun games like a treasure hunt and a three-legged race. We also had a delicious barbecue. What made it memorable for me was seeing all my cousins together and playing so happily. My aunt also baked a huge, amazing cake that everyone loved.",
                checklist: [
                    "Did I clearly state the memorable event or celebration?",
                    "Did I describe what happened during the event (activities, food, etc.)?",
                    "Did I explain what made the event memorable for me personally?",
                    "Did I use descriptive language to make the event sound interesting?",
                    "Is my answer at least 5 sentences long?",
                    "Did I check for spelling and grammar errors?"
                ],
                passage: null
            },
            {
                type: 'essay',
                prompt: "Imagine you are packing your school bag for tomorrow. Describe what you put inside. Use at least two countable nouns with quantifiers (e.g., three pens, some books) and at least two uncountable nouns with quantifiers (e.g., a little water, some homework).",
                modelAnswer: "Tomorrow, I'm packing my school bag carefully. I'll put in three notebooks for my classes and several textbooks. I also need to pack some homework that is due. For lunch, I'll take a little fruit juice and a sandwich. I must not forget my pencil case which has many pens and a few erasers.",
                checklist: [
                    "Did I describe items I would put in a school bag?",
                    "Did I use at least two countable nouns with suitable quantifiers?",
                    "Are the countable noun sentences grammatically correct?",
                    "Did I use at least two uncountable nouns with suitable quantifiers?",
                    "Are the uncountable noun sentences grammatically correct?",
                    "Does my description make sense?"
                ],
                passage: null
            },
            {
                type: 'essay',
                prompt: "Think of a place you know well (like your bedroom, a park, or a classroom). Describe this place using at least five different adjectives. After your description, list the five adjectives you used.",
                modelAnswer: "My bedroom is my favorite place. It's a cozy room with bright yellow walls. There's a large window that lets in a lot of natural light, and I have a comfortable bed with soft pillows. On my desk, I keep my colorful collection of storybooks.\n\nAdjectives used: cozy, bright, yellow, large, natural, comfortable, soft, colorful.",
                checklist: [
                    "Did I choose a specific place to describe?",
                    "Did I use at least five different adjectives in my description?",
                    "Does my description give a clear picture of the place?",
                    "Did I list the adjectives I used after the description?",
                    "Is my description and list grammatically correct and well-spelled?"
                ],
                passage: null
            },
            {
                type: 'essay',
                prompt: "Think about how your daily routine or your neighborhood has changed compared to a few years ago. Write three sentences describing these changes using 'used to' (one positive, one negative, and one question about a past habit).",
                modelAnswer: "Positive: My neighborhood used to have a small bakery on the corner, which smelled wonderful.\nNegative: I didn't use to wake up so early for school when I was younger.\nQuestion: Did there use to be more trees in the park across the street?",
                checklist: [
                    "Did I write a correct positive sentence using 'used to' describing a past state/habit?",
                    "Did I write a correct negative sentence using 'didn't use to' describing a past state/habit?",
                    "Did I write a correct question using 'Did... use to...' about a past state/habit?",
                    "Do my sentences reflect a change from the past to the present?",
                    "Are all sentences grammatically correct and well-spelled?"
                ],
                passage: null
            }
        ];
        
        const mcqCount = questions.filter(q => q.type !== 'essay').length;

        const passageArea = document.getElementById('passage-area');
        const passageTextEl = document.getElementById('passage-text');
        const progressTextEl = document.getElementById('progress-text');
        const questionTextEl = document.getElementById('question-text');
        const optionsContainerEl = document.getElementById('options-container');
        const feedbackAreaEl = document.getElementById('feedback-area');
        // feedbackTextEl will be the <p> tag created dynamically inside feedbackAreaEl
        const submitButton = document.getElementById('submit-button');
        const nextButton = document.getElementById('next-button');
        const scoreAreaEl = document.getElementById('score-area');
        const mcrScoreTextEl = document.getElementById('mcr-score-text');
        const mcrPercentageTextEl = document.getElementById('mcr-percentage-text');
        const restartButton = document.getElementById('restart-button');
        const questionAreaEl = document.getElementById('question-area');
        const navigationAreaEl = document.getElementById('navigation-area');
        const progressBarEl = document.getElementById('progress-bar');

        let currentQuestionIndex = 0;
        let score = 0;
        let selectedOptionButton = null;
        let essayTextarea = null;

        function updateProgressBar() {
            if (questions.length === 0) { progressBarEl.style.width = '0%'; return; }
            const progressPercentage = ((currentQuestionIndex + 1) / questions.length) * 100;
            progressBarEl.style.width = `${progressPercentage}%`;
        }

        function loadQuestion() {
            selectedOptionButton = null;
            essayTextarea = null;
            submitButton.disabled = true;
            // Clear the entire feedback area and recreate the base <p> for feedback text
            feedbackAreaEl.innerHTML = '<p id="feedback-text" class="font-medium"></p>'; 
            
            const currentQuestion = questions[currentQuestionIndex];

            passageArea.style.display = currentQuestion.passage ? 'block' : 'none';
            if (currentQuestion.passage) {
                passageTextEl.textContent = currentQuestion.passage;
            }

            progressTextEl.textContent = `Item ${currentQuestionIndex + 1} of ${questions.length}`;
            questionTextEl.textContent = currentQuestion.type === 'essay' ? currentQuestion.prompt : currentQuestion.question;
            optionsContainerEl.innerHTML = ''; 

            if (currentQuestion.type === 'essay') {
                const label = document.createElement('label');
                label.htmlFor = 'essay-answer';
                label.className = 'block text-sm font-medium text-slate-700 mb-1';
                label.textContent = "Type your answer below:";
                
                essayTextarea = document.createElement('textarea');
                essayTextarea.id = 'essay-answer';
                essayTextarea.className = 'essay-textarea';
                essayTextarea.rows = 8;
                essayTextarea.addEventListener('input', () => {
                    submitButton.disabled = essayTextarea.value.trim() === '';
                });
                optionsContainerEl.appendChild(label);
                optionsContainerEl.appendChild(essayTextarea);
                submitButton.disabled = true; 
            } else { // MCQ
                currentQuestion.options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.classList.add('option-button', 'w-full', 'text-left', 'p-3', 'sm:p-3.5', 'text-sm', 'sm:text-base', 'border-slate-300');
                    button.dataset.index = index;
                    button.addEventListener('click', () => selectMCQOption(button, index));
                    optionsContainerEl.appendChild(button);
                });
            }

            submitButton.style.display = 'block';
            nextButton.style.display = 'none';
            enableInteraction();
            updateProgressBar(); 
        }

        function selectMCQOption(button, index) {
            if (submitButton.style.display === 'none') return; 
            if (selectedOptionButton) {
                selectedOptionButton.classList.remove('selected');
            }
            selectedOptionButton = button;
            selectedOptionButton.classList.add('selected');
            submitButton.disabled = false;
        }

        function handleSubmit() {
            const currentQuestion = questions[currentQuestionIndex];
            disableInteraction();
            
            const currentFeedbackTextEl = document.getElementById('feedback-text'); // Get the fresh p tag

            if (currentQuestion.type === 'essay') {
                currentFeedbackTextEl.innerHTML = `<p class="text-blue-600 font-medium mb-3 text-sm sm:text-base">Answer Submitted. Please review the model answer and checklist below to self-assess your writing.</p>`;
                
                const essayFeedbackDiv = document.createElement('div');
                essayFeedbackDiv.className = 'essay-feedback-container';
                essayFeedbackDiv.innerHTML = `
                    <div>
                        <h4>Model Answer:</h4>
                        <p class="whitespace-pre-line">${currentQuestion.modelAnswer}</p>
                    </div>
                    <div>
                        <h4>Self-Checklist:</h4>
                        <ul>${currentQuestion.checklist.map(item => `<li>${item}</li>`).join('')}</ul>
                    </div>`;
                // Append the essay feedback div AFTER the initial "Answer Submitted" message, which is inside currentFeedbackTextEl's parent (feedbackAreaEl)
                feedbackAreaEl.appendChild(essayFeedbackDiv);
            } else { // MCQ
                if (!selectedOptionButton) return; // Should not happen if button is enabled
                const selectedAnswerIndex = parseInt(selectedOptionButton.dataset.index);
                const correctAnswerIndex = currentQuestion.answer;
                let feedbackMessage = '';

                if (selectedAnswerIndex === correctAnswerIndex) {
                    score++;
                    selectedOptionButton.classList.remove('selected');
                    selectedOptionButton.classList.add('correct');
                    feedbackMessage = 'Correct!';
                    currentFeedbackTextEl.className = 'font-medium text-green-600 text-sm sm:text-base';
                } else {
                    selectedOptionButton.classList.remove('selected');
                    selectedOptionButton.classList.add('incorrect');
                    if (optionsContainerEl.children[correctAnswerIndex]) {
                         optionsContainerEl.children[correctAnswerIndex].classList.add('correct');
                    }
                    feedbackMessage = `Incorrect. The correct answer was: "${currentQuestion.options[correctAnswerIndex]}"`;
                    currentFeedbackTextEl.className = 'font-medium text-red-600 text-sm sm:text-base';
                }
                currentFeedbackTextEl.innerHTML = feedbackMessage; // Set "Correct/Incorrect"
                
                if (currentQuestion.explanation) { // Append explanation to the same <p>
                    const explanationSpan = document.createElement('span');
                    explanationSpan.className = 'mcq-explanation-text';
                    explanationSpan.textContent = currentQuestion.explanation;
                    currentFeedbackTextEl.appendChild(explanationSpan);
                }
            }

            submitButton.style.display = 'none';
            nextButton.style.display = 'block';
            if (currentQuestionIndex === questions.length - 1) {
                nextButton.textContent = 'Show Results';
            }
        }

        function handleNext() {
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                loadQuestion();
            } else {
                showResults();
            }
        }

        function disableInteraction() {
            if (essayTextarea) {
                essayTextarea.disabled = true;
            }
            Array.from(optionsContainerEl.children).forEach(element => {
                if(element.tagName === 'BUTTON') {
                    element.disabled = true;
                    element.classList.remove('hover:bg-slate-100', 'hover:border-blue-400'); 
                }
            });
        }

        function enableInteraction() {
            if (essayTextarea) {
                essayTextarea.disabled = false;
            }
             Array.from(optionsContainerEl.children).forEach(element => {
                if(element.tagName === 'BUTTON') {
                    element.disabled = false;
                }
            });
        }

        function showResults() {
            questionAreaEl.style.display = 'none';
            navigationAreaEl.style.display = 'none';
            feedbackAreaEl.style.display = 'none'; 
            passageArea.style.display = 'none';
            document.querySelector('.progress-bar-container').style.display = 'none'; 
            scoreAreaEl.style.display = 'block';

            const percentage = mcqCount > 0 ? ((score / mcqCount) * 100).toFixed(1) : 0;
            mcrScoreTextEl.textContent = `Multiple Choice Score: ${score} out of ${mcqCount}`;
            mcrPercentageTextEl.textContent = mcqCount > 0 ? `You scored ${percentage}% on the multiple-choice section.` : "No multiple-choice questions were present.";
        }

        function restartQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            questionAreaEl.style.display = 'block';
            navigationAreaEl.style.display = 'flex';
            feedbackAreaEl.style.display = 'block'; 
            feedbackAreaEl.innerHTML = '<p id="feedback-text" class="font-medium"></p>'; // Reset feedback area
            scoreAreaEl.style.display = 'none';
            document.querySelector('.progress-bar-container').style.display = 'block'; 
            nextButton.textContent = 'Next Question'; 
            loadQuestion();
        }

        submitButton.addEventListener('click', handleSubmit);
        nextButton.addEventListener('click', handleNext);
        restartButton.addEventListener('click', restartQuiz);

        loadQuestion();
    </script>
</body>
</html>
